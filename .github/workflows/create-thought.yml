name: Create Thought

on:
  repository_dispatch:
    types: [create-thought]

jobs:
  create-thought:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Get current date and time
        id: date
        run: |
          echo "date=$(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT
          echo "time=$(date +'%H:%M')" >> $GITHUB_OUTPUT

      - name: Create thought file
        run: |
          SLUG="${{ github.event.client_payload.slug }}"
          TAGS="${{ github.event.client_payload.tags }}"
          CONTENT="${{ github.event.client_payload.content }}"
          DATE="${{ steps.date.outputs.date }}"
          TIME="${{ steps.date.outputs.time }}"

          # Create the markdown file
          FILE_PATH="src/content/thoughts/${SLUG}.md"

          # Build frontmatter
          echo "---" > "$FILE_PATH"
          echo "pubDate: ${DATE}" >> "$FILE_PATH"
          echo "pubTime: \"${TIME}\"" >> "$FILE_PATH"

          # Add tags if provided
          if [ -n "$TAGS" ]; then
            # Convert comma-separated tags to array format
            FORMATTED_TAGS=$(echo "$TAGS" | sed 's/,\s*/", "/g')
            echo "tags: [\"${FORMATTED_TAGS}\"]" >> "$FILE_PATH"
          fi

          echo "---" >> "$FILE_PATH"
          echo "" >> "$FILE_PATH"
          echo "$CONTENT" >> "$FILE_PATH"

          cat "$FILE_PATH"

      - name: Commit and push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add src/content/thoughts/
          git commit -m "ðŸ’­ Add thought: ${{ github.event.client_payload.slug }}"
          git push
