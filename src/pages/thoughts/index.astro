---
import { getCollection } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';
import { formatDate } from '../../utils/formatDate';

const thoughts = (await getCollection('thoughts'))
  .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());
---

<BaseLayout
  title="Thoughts - Stephen McCullough"
  description="Short-form thoughts and micro-posts from Stephen McCullough"
>
  <div class="space-y-12">
    <div class="space-y-4">
      <h1 style="color: var(--color-text-heading);" class="text-4xl md:text-5xl font-bold tracking-tight">
        Thoughts
      </h1>
      <p style="color: var(--color-text-secondary);" class="text-lg md:text-xl leading-relaxed">
        Short-form posts and quick thoughts
      </p>
    </div>

    <!-- Search and Filter -->
    <div class="not-prose">
      <div class="flex flex-col sm:flex-row gap-4 items-start">
        <div class="flex-1 w-full">
          <label for="thought-search" class="sr-only">Search thoughts</label>
          <input
            type="text"
            id="thought-search"
            placeholder="ðŸ” Search thoughts..."
            class="w-full px-4 py-2 rounded-lg border transition-colors"
            style="background: var(--color-bg-secondary); color: var(--color-text); border-color: var(--color-border);"
          />
        </div>

        <div class="relative">
          <button
            id="filter-toggle"
            type="button"
            class="flex items-center gap-2 px-4 py-2 rounded-lg border transition-colors whitespace-nowrap"
            style="background: var(--color-bg-secondary); color: var(--color-text); border-color: var(--color-border);"
          >
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"></path>
            </svg>
            <span>Filter by tag</span>
            <span id="filter-count" class="hidden px-2 py-0.5 rounded-full text-xs font-bold" style="background: var(--color-accent); color: white;"></span>
          </button>

          <div
            id="filter-panel"
            class="hidden absolute right-0 mt-2 p-4 rounded-lg border shadow-lg z-10 min-w-[300px]"
            style="background: var(--color-bg); border-color: var(--color-border);"
          >
            <div class="flex items-center justify-between mb-3">
              <span class="text-sm font-medium" style="color: var(--color-text-heading);">Filter by Tag</span>
              <button
                id="clear-filters"
                class="text-xs px-2 py-1 rounded transition-opacity hover:opacity-70"
                style="color: var(--color-accent);"
              >
                Clear all
              </button>
            </div>
            <div class="flex flex-wrap gap-2" id="tag-filters"></div>
          </div>
        </div>
      </div>

      <div id="active-filters" class="flex flex-wrap gap-2 mt-4 empty:mt-0"></div>
    </div>

    <div class="space-y-6" id="thoughts-list">
      {thoughts.map(async (thought) => {
        const { Content } = await thought.render();
        return (
          <article
            class="card group thought-item"
            data-tags={(thought.data.tags || []).join(',').toLowerCase()}
          >
            <div class="space-y-3">
              <div style="color: var(--color-text); font-size: 1.125rem; line-height: 1.8;" class="prose prose-lg dark:prose-invert max-w-none thought-content">
                <Content />
              </div>
              <div class="flex items-center justify-between pt-2">
                <time style="color: var(--color-text-muted);" class="text-sm" datetime={thought.data.pubDate.toISOString()}>
                  {formatDate(thought.data.pubDate)}
                  {thought.data.pubTime && <span class="ml-2">at {thought.data.pubTime}</span>}
                </time>
                {thought.data.tags && thought.data.tags.length > 0 && (
                  <div class="flex flex-wrap gap-2">
                    {thought.data.tags.map((tag) => (
                      <span
                        style="background: var(--color-bg-secondary); color: var(--color-accent); border: 1px solid var(--color-border);"
                        class="px-2.5 py-1 rounded text-xs font-medium cursor-pointer hover:opacity-70 transition-opacity tag-chip"
                        data-tag={tag.toLowerCase()}
                      >
                        {tag}
                      </span>
                    ))}
                  </div>
                )}
              </div>
            </div>
          </article>
        );
      })}
    </div>

    <div id="no-results" class="hidden text-center py-12">
      <p style="color: var(--color-text); font-size: 1.125rem;">
        No thoughts found matching your search.
      </p>
    </div>
  </div>

  <style>
    article :global(p) {
      color: var(--color-text);
      margin: 0;
    }

    article :global(a) {
      color: var(--color-accent);
    }

    article :global(a:hover) {
      color: var(--color-accent-hover);
    }

    article :global(strong) {
      color: var(--color-text-heading);
    }

    article :global(code) {
      background-color: var(--color-surface);
      color: var(--color-accent-purple);
      padding: 0.2em 0.4em;
      border-radius: 4px;
      font-size: 0.9em;
    }

    #thought-search:focus {
      outline: 2px solid var(--color-accent);
      outline-offset: 2px;
    }

    .tag-filter {
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .tag-filter:hover {
      opacity: 0.7;
    }

    .tag-filter.active {
      background: var(--color-accent) !important;
      color: white !important;
    }

    .thought-item.hidden {
      display: none;
    }

    #filter-toggle:hover {
      opacity: 0.8;
    }

    #filter-panel {
      max-height: 400px;
      overflow-y: auto;
    }

    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    #filter-panel:not(.hidden) {
      animation: slideDown 0.2s ease-out;
    }
  </style>

  <script>
    const thoughtItems = document.querySelectorAll('.thought-item');
    const allTags = new Set<string>();

    thoughtItems.forEach(item => {
      const tags = item.getAttribute('data-tags')?.split(',') || [];
      tags.forEach(tag => tag && allTags.add(tag.trim()));
    });

    const tagFiltersContainer = document.getElementById('tag-filters');
    const sortedTags = Array.from(allTags).sort();

    sortedTags.forEach(tag => {
      const button = document.createElement('button');
      button.className = 'tag-filter px-3 py-1 rounded-full text-xs font-medium';
      button.style.cssText = 'background: var(--color-bg-secondary); color: var(--color-accent); border: 1px solid var(--color-border);';
      button.setAttribute('data-tag', tag);
      button.textContent = tag.split(' ').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
      tagFiltersContainer!.appendChild(button);
    });

    let activeTagFilters = new Set<string>();
    let searchQuery = '';

    function filterThoughts() {
      let visibleCount = 0;

      thoughtItems.forEach(item => {
        const content = item.querySelector('.thought-content')?.textContent?.toLowerCase() || '';
        const tags = item.getAttribute('data-tags') || '';

        const matchesSearch = !searchQuery || content.includes(searchQuery) || tags.includes(searchQuery);
        const matchesTags = activeTagFilters.size === 0 || Array.from(activeTagFilters).every(filterTag => tags.split(',').some(itemTag => itemTag.trim() === filterTag));

        if (matchesSearch && matchesTags) {
          item.classList.remove('hidden');
          visibleCount++;
        } else {
          item.classList.add('hidden');
        }
      });

      const noResults = document.getElementById('no-results');
      if (visibleCount === 0) {
        noResults?.classList.remove('hidden');
      } else {
        noResults?.classList.add('hidden');
      }

      updateActiveFilters();
    }

    function updateActiveFilters() {
      const activeFiltersContainer = document.getElementById('active-filters');
      const filterCount = document.getElementById('filter-count');
      if (!activeFiltersContainer || !filterCount) return;

      activeFiltersContainer.innerHTML = '';

      if (activeTagFilters.size > 0) {
        filterCount.textContent = activeTagFilters.size.toString();
        filterCount.classList.remove('hidden');
      } else {
        filterCount.classList.add('hidden');
      }

      if (activeTagFilters.size === 0 && !searchQuery) return;

      activeTagFilters.forEach(tag => {
        const chip = document.createElement('button');
        chip.className = 'inline-flex items-center gap-1.5 px-3 py-1 rounded-full text-xs font-medium transition-opacity hover:opacity-70';
        chip.style.cssText = 'background: var(--color-accent); color: white;';

        const tagText = document.createElement('span');
        tagText.textContent = tag.split(' ').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');

        const removeIcon = document.createElement('span');
        removeIcon.innerHTML = 'Ã—';
        removeIcon.className = 'text-lg leading-none';

        chip.appendChild(tagText);
        chip.appendChild(removeIcon);

        chip.addEventListener('click', () => {
          activeTagFilters.delete(tag);
          const filterButton = document.querySelector(`.tag-filter[data-tag="${tag}"]`);
          if (filterButton) filterButton.classList.remove('active');
          filterThoughts();
        });

        activeFiltersContainer.appendChild(chip);
      });
    }

    const filterToggle = document.getElementById('filter-toggle');
    const filterPanel = document.getElementById('filter-panel');

    filterToggle?.addEventListener('click', () => filterPanel?.classList.toggle('hidden'));

    document.addEventListener('click', (e) => {
      if (!filterToggle?.contains(e.target as Node) && !filterPanel?.contains(e.target as Node)) {
        filterPanel?.classList.add('hidden');
      }
    });

    document.getElementById('clear-filters')?.addEventListener('click', () => {
      activeTagFilters.clear();
      searchQuery = '';
      (document.getElementById('thought-search') as HTMLInputElement).value = '';
      document.querySelectorAll('.tag-filter').forEach(btn => btn.classList.remove('active'));
      filterThoughts();
    });

    document.getElementById('thought-search')?.addEventListener('input', (e) => {
      searchQuery = (e.target as HTMLInputElement).value.toLowerCase().trim();
      filterThoughts();
    });

    document.querySelectorAll('.tag-filter').forEach(button => {
      button.addEventListener('click', () => {
        const tag = button.getAttribute('data-tag');
        if (!tag) return;

        if (activeTagFilters.has(tag)) {
          activeTagFilters.delete(tag);
          button.classList.remove('active');
        } else {
          activeTagFilters.add(tag);
          button.classList.add('active');
        }

        filterThoughts();
      });
    });

    document.querySelectorAll('.tag-chip').forEach(chip => {
      chip.addEventListener('click', (e) => {
        e.preventDefault();
        const tag = chip.getAttribute('data-tag');
        if (!tag) return;

        const filterButton = document.querySelector(`.tag-filter[data-tag="${tag}"]`);

        if (filterButton) {
          if (activeTagFilters.has(tag)) {
            activeTagFilters.delete(tag);
            filterButton.classList.remove('active');
          } else {
            activeTagFilters.add(tag);
            filterButton.classList.add('active');
          }

          filterThoughts();
        }
      });
    });
  </script>
</BaseLayout>
