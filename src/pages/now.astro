---
import { getCollection } from 'astro:content';
import BaseLayout from '../layouts/BaseLayout.astro';
import { formatDate } from '../utils/formatDate';

const nowEntries = await getCollection('now');
const currentNowEntry = nowEntries.find(entry => !entry.data.archived);
const currentNow = currentNowEntry ? await currentNowEntry.render() : null;

// Get the most recent archived entry for the "previous" link
const archivedEntries = nowEntries
  .filter(entry => entry.data.archived)
  .sort((a, b) => b.data.updatedDate.valueOf() - a.data.updatedDate.valueOf());
const previousEntry = archivedEntries[0];
---

<BaseLayout
  title="Now - Stephen McCullough"
  description="What Stephen McCullough is currently working on and focused on"
>
  <article class="prose prose-lg dark:prose-invert max-w-none space-y-8" style="color: var(--color-text);">
    <div class="space-y-4">
      <h1 style="color: var(--color-text-heading);">What I'm Doing Now</h1>

      <p style="color: var(--color-text-muted);" class="text-sm">
        Last updated: {currentNowEntry && formatDate(currentNowEntry.data.updatedDate)}
      </p>
    </div>

    <div class="space-y-5" style="color: var(--color-text); font-size: 1.125rem; line-height: 1.8;">
      {currentNow ? (
        <currentNow.Content />
      ) : (
        <p style="color: var(--color-text-secondary);">Check back soon for updates on what I'm currently working on.</p>
      )}
    </div>

    <hr style="border-color: var(--color-border);" />

    <p class="text-sm" style="color: var(--color-text-muted);">
      This is a <a href="https://nownownow.com/about" target="_blank" rel="noopener noreferrer" style="color: var(--color-accent);">"now" page</a>,
      inspired by Derek Sivers. It's a snapshot of what I'm focused on at this point in time.
    </p>

    {previousEntry && (
      <p class="text-sm" style="color: var(--color-text-muted);">
        <a href={`/now/${previousEntry.slug}`} style="color: var(--color-accent);" class="hover:underline">
          ← Previous ({previousEntry.data.month || previousEntry.data.updatedDate.toLocaleDateString('en-GB', { month: 'long' })} {previousEntry.data.year || previousEntry.data.updatedDate.getFullYear()})
        </a>
      </p>
    )}

    {archivedEntries.length > 0 && (
      <p class="text-sm" style="color: var(--color-text-muted);">
        <a href="/now/archive" style="color: var(--color-accent);" class="hover:underline">
          View archive →
        </a>
      </p>
    )}
  </article>

  <style>
    article :global(h2),
    article :global(h3),
    article :global(h4) {
      color: var(--color-text-heading);
      font-family: 'Space Grotesk', sans-serif;
      margin-top: 0;
    }

    article :global(p) {
      color: var(--color-text);
      margin-bottom: 1.5rem;
      line-height: 1.8;
    }

    article :global(a) {
      color: var(--color-accent);
    }

    article :global(a:hover) {
      color: var(--color-accent-hover);
    }

    article :global(strong) {
      color: var(--color-text-heading);
    }

    article :global(code) {
      background-color: var(--color-surface);
      color: var(--color-accent-purple);
      padding: 0.2em 0.4em;
      border-radius: 4px;
      font-size: 0.9em;
    }
  </style>
</BaseLayout>
